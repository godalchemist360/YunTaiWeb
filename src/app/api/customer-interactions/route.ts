export const runtime = 'nodejs';

import { getCurrentUserId } from '@/lib/auth';
import { query } from '@/lib/db';
// import { withPerformanceMonitoring, withQueryMonitoring } from '@/lib/api-performance';
import { NextResponse } from 'next/server';

export async function POST(req: Request) {
  try {
    const userId = await getCurrentUserId(req);
    const body = await req.json();

    const {
      salesperson,
      customerName,
      leadSource,
      leadSourceOther,
      consultationMotives,
      consultationMotivesOther,
      assetLiability,
      incomeExpense,
      situation,
      newItemInputs,
    } = body;

    // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
    if (!salesperson || !customerName || !leadSource) {
      return NextResponse.json(
        { error: 'Ê•≠ÂãôÂì°„ÄÅÂÆ¢Êà∂ÂêçÁ®±ÂíåÂêçÂñÆ‰æÜÊ∫êÁÇ∫ÂøÖÂ°´Ê¨Ñ‰Ωç' },
        { status: 400 }
      );
    }

    // ËôïÁêÜÂêçÂñÆ‰æÜÊ∫ê
    const finalLeadSource =
      leadSource === 'ÂÖ∂‰ªñ' && leadSourceOther ? leadSourceOther : leadSource;

    // ËôïÁêÜË´ÆË©¢ÂãïÊ©ü
    const allMotives = [...consultationMotives];
    if (
      consultationMotives.includes('ÂÖ∂‰ªñ') &&
      consultationMotivesOther.length > 0
    ) {
      allMotives.push(
        ...consultationMotivesOther.filter((motive: string) => motive.trim())
      );
    }

    if (allMotives.length === 0) {
      return NextResponse.json(
        { error: 'Ëá≥Â∞ëÈúÄË¶ÅÈÅ∏Êìá‰∏ÄÂÄãË´ÆË©¢ÂãïÊ©ü' },
        { status: 400 }
      );
    }

    // ÁîüÊàêÂîØ‰∏Ä ID
    const id = `interaction-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // ËΩâÊèõË≥áÁî¢Ë≤†ÂÇµË≥áÊñôÊ†ºÂºèÔºàÂæûÂµåÂ•óÊ†ºÂºèËΩâÁÇ∫Âπ≥Èã™Ê†ºÂºèÔºâ
    const assetLiabilityData: { [key: string]: number } = {};

    // Ë≥áÁî¢
    if (assetLiability.assets?.realEstate)
      assetLiabilityData.‰∏çÂãïÁî¢ÂÉπÂÄº =
        Number.parseFloat(assetLiability.assets.realEstate) || 0;
    if (assetLiability.assets?.cash)
      assetLiabilityData.ÁèæÈáë =
        Number.parseFloat(assetLiability.assets.cash) || 0;
    if (assetLiability.assets?.stocks)
      assetLiabilityData['ËÇ°Á•®„ÄÅETF'] =
        Number.parseFloat(assetLiability.assets.stocks) || 0;
    if (assetLiability.assets?.funds)
      assetLiabilityData.Âü∫Èáë =
        Number.parseFloat(assetLiability.assets.funds) || 0;
    if (assetLiability.assets?.insurance)
      assetLiabilityData.‰øùÈö™ =
        Number.parseFloat(assetLiability.assets.insurance) || 0;
    if (assetLiability.assets?.others)
      assetLiabilityData.ÂÖ∂‰ªñË≥áÁî¢ =
        Number.parseFloat(assetLiability.assets.others) || 0;

    // ÂãïÊÖãÊñ∞Â¢ûÁöÑË≥áÁî¢È†ÖÁõÆ
    if (newItemInputs?.assets) {
      newItemInputs.assets.forEach((item: { name: string; value: string }) => {
        if (item.name && item.value) {
          assetLiabilityData[`Ë≥áÁî¢_${item.name}`] =
            Number.parseFloat(item.value) || 0;
        }
      });
    }

    // Ë≤†ÂÇµ
    if (assetLiability.liabilities?.mortgage)
      assetLiabilityData.ÊàøË≤∏ =
        Number.parseFloat(assetLiability.liabilities.mortgage) || 0;
    if (assetLiability.liabilities?.carLoan)
      assetLiabilityData.ËªäË≤∏ =
        Number.parseFloat(assetLiability.liabilities.carLoan) || 0;
    if (assetLiability.liabilities?.creditLoan)
      assetLiabilityData.‰ø°Ë≤∏ =
        Number.parseFloat(assetLiability.liabilities.creditLoan) || 0;
    if (assetLiability.liabilities?.creditCard)
      assetLiabilityData.Âç°Âæ™ =
        Number.parseFloat(assetLiability.liabilities.creditCard) || 0;
    if (assetLiability.liabilities?.studentLoan)
      assetLiabilityData.Â≠∏Ë≤∏ =
        Number.parseFloat(assetLiability.liabilities.studentLoan) || 0;
    if (assetLiability.liabilities?.installment)
      assetLiabilityData.ËûçË≥áÂàÜÊúü =
        Number.parseFloat(assetLiability.liabilities.installment) || 0;
    if (assetLiability.liabilities?.otherLoans)
      assetLiabilityData.ÂÖ∂‰ªñË≤∏Ê¨æ =
        Number.parseFloat(assetLiability.liabilities.otherLoans) || 0;

    // ÂãïÊÖãÊñ∞Â¢ûÁöÑË≤†ÂÇµÈ†ÖÁõÆ
    if (newItemInputs?.liabilities) {
      newItemInputs.liabilities.forEach(
        (item: { name: string; value: string }) => {
          if (item.name && item.value) {
            assetLiabilityData[`Ë≤†ÂÇµ_${item.name}`] =
              Number.parseFloat(item.value) || 0;
          }
        }
      );
    }

    // ÂÆ∂Â∫≠Ë≥áÊ∫ê
    if (assetLiability.familyResources?.familyProperties)
      assetLiabilityData.ÂÆ∂‰∫∫ÊúâÂπæÈñìÊàø =
        Number.parseFloat(assetLiability.familyResources.familyProperties) || 0;
    if (assetLiability.familyResources?.familyAssets)
      assetLiabilityData['‰øùÂñÆ„ÄÅËÇ°Á•®„ÄÅÁèæÈáë'] =
        Number.parseFloat(assetLiability.familyResources.familyAssets) || 0;
    if (assetLiability.familyResources?.others)
      assetLiabilityData.ÂÖ∂‰ªñÂÆ∂Â∫≠Ë≥áÊ∫ê =
        Number.parseFloat(assetLiability.familyResources.others) || 0;

    // ÂãïÊÖãÊñ∞Â¢ûÁöÑÂÆ∂Â∫≠Ë≥áÊ∫êÈ†ÖÁõÆ
    if (newItemInputs?.familyResources) {
      newItemInputs.familyResources.forEach(
        (item: { name: string; value: string }) => {
          if (item.name && item.value) {
            assetLiabilityData[`ÂÆ∂Â∫≠Ë≥áÊ∫ê_${item.name}`] =
              Number.parseFloat(item.value) || 0;
          }
        }
      );
    }

    // ËΩâÊèõÊî∂ÊîØË≥áÊñôÊ†ºÂºè
    const incomeExpenseData: { [key: string]: string } = {};

    // Êî∂ÂÖ•
    if (incomeExpense.income?.mainIncome)
      incomeExpenseData.‰∏ªÊ•≠Êî∂ÂÖ• = incomeExpense.income.mainIncome;
    if (incomeExpense.income?.sideIncome)
      incomeExpenseData.ÂâØÊ•≠Êî∂ÂÖ• = incomeExpense.income.sideIncome;
    if (incomeExpense.income?.otherIncome)
      incomeExpenseData.ÂÖ∂‰ªñÊî∂ÂÖ• = incomeExpense.income.otherIncome;

    // ÂãïÊÖãÊñ∞Â¢ûÁöÑÊî∂ÂÖ•È†ÖÁõÆ
    if (newItemInputs?.income) {
      newItemInputs.income.forEach((item: { name: string; value: string }) => {
        if (item.name && item.value) {
          incomeExpenseData[`Êî∂ÂÖ•_${item.name}`] = item.value;
        }
      });
    }

    // ÊîØÂá∫
    if (incomeExpense.expenses?.livingExpenses)
      incomeExpenseData.ÁîüÊ¥ªË≤ª = incomeExpense.expenses.livingExpenses;
    if (incomeExpense.expenses?.housingExpenses)
      incomeExpenseData.ÊàøÁßüÊàñÊàøË≤∏ = incomeExpense.expenses.housingExpenses;
    if (incomeExpense.expenses?.otherExpenses)
      incomeExpenseData.‰øùË≤ª = incomeExpense.expenses.otherExpenses;

    // ÂãïÊÖãÊñ∞Â¢ûÁöÑÊîØÂá∫È†ÖÁõÆ
    if (newItemInputs?.expenses) {
      newItemInputs.expenses.forEach(
        (item: { name: string; value: string }) => {
          if (item.name && item.value) {
            incomeExpenseData[`ÊîØÂá∫_${item.name}`] = item.value;
          }
        }
      );
    }

    // ÊúàÁµêÈ§ò
    if (incomeExpense.monthlyBalance)
      incomeExpenseData.ÊúàÁµêÈ§ò = incomeExpense.monthlyBalance;

    // ËΩâÊèõÁèæÊ≥ÅË™™ÊòéË≥áÊñôÊ†ºÂºè
    const situationData: { [key: string]: string } = {};
    if (situation.painPoints) situationData.ÁóõÈªû = situation.painPoints;
    if (situation.goals) situationData.ÁõÆÊ®ô = situation.goals;
    if (situation.familyRelationships)
      situationData.Èóú‰øÇ = situation.familyRelationships;
    if (situation.others) situationData.ÂÖ∂‰ªñ = situation.others;

    // ÊèíÂÖ•Ë≥áÊñôÂ∫´
    const insertSQL = `
      INSERT INTO customer_interactions (
        id, salesperson, customer_name, lead_source, consultation_motives,
        asset_liability_data, income_expense_data, situation_data,
        meeting_count, created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW()
      )
    `;

    await query(insertSQL, [
      id,
      salesperson,
      customerName,
      finalLeadSource,
      allMotives,
      Object.keys(assetLiabilityData).length > 0
        ? JSON.stringify(assetLiabilityData)
        : null,
      Object.keys(incomeExpenseData).length > 0
        ? JSON.stringify(incomeExpenseData)
        : null,
      Object.keys(situationData).length > 0
        ? JSON.stringify(situationData)
        : null,
      0, // meeting_count Ë®≠ÁÇ∫ 0
    ]);

    return NextResponse.json({
      success: true,
      id,
      message: 'ÂÆ¢Êà∂‰∫íÂãïË®òÈåÑÊñ∞Â¢ûÊàêÂäü',
    });
  } catch (error) {
    console.error('Error creating customer interaction:', error);
    return NextResponse.json({ error: 'Êñ∞Â¢ûË®òÈåÑÂ§±Êïó' }, { status: 500 });
  }
}

async function _getCustomerInteractions(req: Request) {
  try {
    const userId = await getCurrentUserId(req);

    const url = new URL(req.url);
    const page = Number(url.searchParams.get('page') ?? '1');
    const pageSize = Number(url.searchParams.get('pageSize') ?? '10');
    const q = url.searchParams.get('q') ?? '';

    // Ë®àÁÆóÂÅèÁßªÈáè
    const offset = (page - 1) * pageSize;

    // Âª∫Á´ãÊêúÂ∞ãÊ¢ù‰ª∂
    const whereConditions: string[] = [];
    const params: any[] = [];
    let paramIndex = 1;

    if (q?.trim()) {
      whereConditions.push(
        `(customer_name ILIKE $${paramIndex} OR salesperson ILIKE $${paramIndex})`
      );
      params.push(`%${q}%`);
      paramIndex++;
    }

    const whereSQL =
      whereConditions.length > 0
        ? `WHERE ${whereConditions.join(' AND ')}`
        : '';

    // ÂÑ™ÂåñÔºöÂêà‰Ωµ COUNT Âíå DATA Êü•Ë©¢ÁÇ∫‰∏ÄÊ¨°Êü•Ë©¢
    console.time('customer_interactions_combined');
    const combinedSQL = `
      WITH data_query AS (
        SELECT
          id,
          salesperson,
          customer_name,
          lead_source,
          consultation_motives,
          next_action_date,
          next_action_description,
          meeting_count,
          meeting_record,
          created_at
        FROM customer_interactions
        ${whereSQL}
        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}
      ),
      count_query AS (
        SELECT COUNT(*) as total FROM customer_interactions ${whereSQL}
      )
      SELECT
        (SELECT total FROM count_query) as total_count,
        json_agg(data_query.*) as items
      FROM data_query
    `;

    console.log('üîç Âü∑Ë°åÂêà‰ΩµÊü•Ë©¢:', combinedSQL, 'ÂèÉÊï∏:', [
      ...params,
      pageSize,
      offset,
    ]);
    const result = await query(combinedSQL, [...params, pageSize, offset]);
    console.timeEnd('customer_interactions_combined');

    const total = Number(result.rows[0].total_count);
    const items = result.rows[0].items || [];
    console.log('üìä Êü•Ë©¢ÁµêÊûúÁ∏ΩÊï∏:', total, 'Á≠ÜÊï∏:', items.length);

    return NextResponse.json({
      items: items,
      total,
      page,
      pageSize,
    });
  } catch (error) {
    console.error('Error fetching customer interactions:', error);
    return NextResponse.json(
      { error: 'INTERNAL_SERVER_ERROR' },
      { status: 500 }
    );
  }
}

// ÊÅ¢Âæ©Ê≠£Â∏∏ÁöÑ GET Â∞éÂá∫
export { _getCustomerInteractions as GET };
